# 忘记密码功能综合测试方案

## 概述

本文档提供了 Cosnap AI 应用程序忘记密码功能的完整测试方案，包括单元测试、集成测试、E2E 测试、边界情况测试和手动验收测试。

## 测试架构

### 1. 测试金字塔结构

```
        E2E Tests (少量)
       ├─ 关键用户流程
       ├─ 浏览器兼容性
       └─ 端到端集成

     Integration Tests (适中)
    ├─ API 与前端集成
    ├─ 完整业务流程
    ├─ 第三方服务集成
    └─ 数据一致性测试

   Unit Tests (大量)
  ├─ API 端点单元测试
  ├─ 前端组件测试
  ├─ Hooks 和工具函数
  └─ 验证和业务逻辑
```

### 2. 测试覆盖范围

- **后端 API**: 密码重置请求、令牌验证、密码更新
- **前端组件**: ForgotPassword、EmailSent、ResetPassword、ResetSuccess
- **Hooks**: useForgotPassword
- **集成流程**: 完整的密码重置流程
- **边界情况**: 网络错误、恶意输入、竞态条件

## 自动化测试

### 单元测试文件

| 文件 | 测试内容 | 框架 |
|------|----------|------|
| `runninghub-backend/__tests__/unit/forgot-password.test.js` | 后端 API 单元测试 | Jest |
| `project/src/components/__tests__/ForgotPassword.test.tsx` | 忘记密码页面组件测试 | Vitest + RTL |
| `project/src/components/__tests__/ResetPassword.test.tsx` | 重置密码页面组件测试 | Vitest + RTL |
| `project/src/hooks/__tests__/useForgotPassword.test.ts` | 自定义 Hook 测试 | Vitest |

### 集成测试文件

| 文件 | 测试内容 | 框架 |
|------|----------|------|
| `runninghub-backend/__tests__/integration/forgot-password-flow.test.js` | 完整后端流程测试 | Jest + Supertest |
| `project/src/components/__tests__/ForgotPasswordFlow.integration.test.tsx` | 前端页面流程测试 | Vitest + RTL |

### E2E 测试文件

| 文件 | 测试内容 | 框架 |
|------|----------|------|
| `project/e2e/forgot-password.spec.ts` | 端到端用户流程测试 | Playwright |

### 边界情况测试文件

| 文件 | 测试内容 | 框架 |
|------|----------|------|
| `runninghub-backend/__tests__/unit/forgot-password-edge-cases.test.js` | 边界情况和错误处理 | Jest |

## 运行测试

### 后端测试

```bash
cd runninghub-backend

# 运行所有测试
npm test

# 运行单元测试
npm run test:unit

# 运行集成测试
npm run test:integration

# 生成覆盖率报告
npm run test:coverage

# 运行特定测试文件
npm test forgot-password
```

### 前端测试

```bash
cd project

# 运行所有测试
npm test

# 运行测试并生成覆盖率
npm run test:coverage

# 运行测试 UI
npm run test:ui

# 运行 E2E 测试
npm run test:e2e

# 运行 E2E 测试（有界面）
npm run test:e2e:headed

# 调试 E2E 测试
npm run test:e2e:debug
```

## 手动测试清单

### 功能验收测试

#### 1. 忘记密码页面 (`/forgot-password`)

**前置条件**: 用户未登录，可以访问忘记密码页面

##### 基本功能
- [ ] 页面正确加载，显示"Reset Password"标题
- [ ] 显示 Cosnap AI 品牌标识
- [ ] 邮箱输入框可见且功能正常
- [ ] "Send Reset Link"按钮可见
- [ ] "Back to Sign In"链接正确指向登录页面

##### 表单验证
- [ ] 空邮箱提交显示"Email is required"错误
- [ ] 无效邮箱格式显示"Please enter a valid email address"错误
- [ ] 有效邮箱格式通过验证
- [ ] 字段错误在用户开始输入时清除
- [ ] 表单提交时禁用输入和按钮

##### 邮箱输入测试用例
```
测试用例 1: 空输入
输入: (空)
期望: "Email is required"错误信息

测试用例 2: 无效格式
输入: "invalid-email"
期望: "Please enter a valid email address"错误信息

测试用例 3: 有效邮箱
输入: "test@example.com"
期望: 无错误，表单可以提交

测试用例 4: 空格处理
输入: "  test@example.com  "
期望: 自动去除空格，使用"test@example.com"提交
```

##### API 交互
- [ ] 成功提交后导航到邮件发送页面
- [ ] 网络错误时显示适当的错误消息
- [ ] 速率限制时显示相应错误
- [ ] 加载状态正确显示

#### 2. 邮件发送页面 (`/forgot-password/email-sent`)

**前置条件**: 从忘记密码页面成功提交邮箱

##### 基本功能
- [ ] 页面显示"Check Your Email"标题
- [ ] 显示用户提交的邮箱地址
- [ ] 显示邮件发送说明
- [ ] 重发按钮初始状态为禁用（倒计时中）
- [ ] 倒计时显示正确格式 (mm:ss)

##### 重发功能
- [ ] 60秒倒计时正确运行
- [ ] 倒计时结束后重发按钮可用
- [ ] 重发成功显示成功消息
- [ ] 重发后重新开始倒计时
- [ ] 重发失败显示错误消息

##### 导航测试
- [ ] 直接访问页面（无状态）重定向到忘记密码页面
- [ ] "Back to Sign In"链接正确工作

#### 3. 重置密码页面 (`/reset-password/:token`)

**前置条件**: 通过有效的重置链接访问

##### 令牌验证
- [ ] 有效令牌显示密码重置表单
- [ ] 无效令牌显示错误页面
- [ ] 过期令牌显示错误页面
- [ ] 令牌验证期间显示加载状态
- [ ] 显示相关的用户邮箱地址

##### 密码表单
- [ ] 新密码输入框可见并功能正常
- [ ] 确认密码输入框可见并功能正常
- [ ] 密码可见性切换按钮工作正常
- [ ] 密码强度指示器正确显示

##### 密码验证测试用例
```
测试用例 1: 空密码
输入: ""
期望: "Password is required"错误

测试用例 2: 过短密码
输入: "short"
期望: "Password must be at least 8 characters long"错误

测试用例 3: 仅字母
输入: "onlyletters"
期望: "Password must contain at least one letter and one number"错误

测试用例 4: 仅数字
输入: "12345678"
期望: "Password must contain at least one letter and one number"错误

测试用例 5: 密码不匹配
新密码: "ValidPassword123!"
确认密码: "DifferentPassword!"
期望: "Passwords do not match"错误

测试用例 6: 有效密码
输入: "ValidPassword123!"
期望: 无错误，强度显示"Strong"
```

##### 密码强度测试
- [ ] "Too weak": 短密码或简单密码
- [ ] "Fair": 满足基本要求（8字符，字母+数字）
- [ ] "Good": 包含大小写字母或特殊字符
- [ ] "Strong": 包含大小写字母、数字和特殊字符

##### 提交流程
- [ ] 有效数据提交成功
- [ ] 表单验证失败时不提交
- [ ] 提交期间显示加载状态
- [ ] 成功后导航到成功页面

#### 4. 重置成功页面 (`/reset-password/success`)

**前置条件**: 成功重置密码

##### 基本功能
- [ ] 显示"Password Reset Successfully!"标题
- [ ] 显示成功动画/图标
- [ ] 显示相关的用户邮箱
- [ ] 显示确认消息

##### 导航选项
- [ ] "Sign In Now"按钮链接到登录页面
- [ ] "Back to Home"链接到首页
- [ ] 安全提示信息正确显示

##### 成功动画
- [ ] 成功图标动画正常播放
- [ ] 页面元素按预期顺序出现
- [ ] 浮动粒子动画（如适用）正常工作

### 用户体验测试

#### 1. 响应式设计测试

##### 桌面端 (≥1024px)
- [ ] 所有元素正确显示和对齐
- [ ] 表单宽度适中，易于阅读
- [ ] 按钮大小和间距合适

##### 平板端 (768px - 1023px)
- [ ] 布局适应中等屏幕尺寸
- [ ] 触摸目标大小足够
- [ ] 内容不被截断

##### 移动端 (< 768px)
- [ ] 单列布局正常工作
- [ ] 输入框最小高度44px（触摸友好）
- [ ] 移动键盘不遮挡重要内容
- [ ] 移动特定属性正确设置（inputMode, enterKeyHint）

#### 2. 浏览器兼容性测试

##### 现代浏览器
- [ ] Chrome (最新版本)
- [ ] Firefox (最新版本)
- [ ] Safari (最新版本)
- [ ] Edge (最新版本)

##### 移动浏览器
- [ ] iOS Safari
- [ ] Android Chrome
- [ ] Samsung Internet

#### 3. 可访问性测试

##### 键盘导航
- [ ] Tab 键正确切换焦点
- [ ] Enter 键可以提交表单
- [ ] Escape 键可以关闭模态框（如适用）
- [ ] 焦点指示器清晰可见

##### 屏幕阅读器
- [ ] 所有表单控件有适当的标签
- [ ] 错误消息正确关联到输入框
- [ ] 页面标题和标题层级正确
- [ ] ARIA 属性正确使用

##### 视觉辅助
- [ ] 颜色对比度符合 WCAG 标准
- [ ] 不仅依赖颜色传达信息
- [ ] 支持高对比度模式
- [ ] 支持系统字体大小设置

### 安全测试

#### 1. 输入验证测试

##### XSS 防护
```
测试用例 1: Script 标签
输入: "<script>alert('xss')</script>@example.com"
期望: 输入被拒绝或安全处理

测试用例 2: 事件处理器
输入: "onload=alert(1)@example.com"
期望: 输入被拒绝或安全处理

测试用例 3: Javascript URL
输入: "javascript:alert(1)@example.com"
期望: 输入被拒绝或安全处理
```

##### SQL 注入防护
```
测试用例 1: 基本 SQL 注入
输入: "'; DROP TABLE users; --"
期望: 输入被安全处理，不执行恶意 SQL

测试用例 2: Union 攻击
输入: "test@example.com' UNION SELECT * FROM passwords --"
期望: 输入被安全处理
```

#### 2. 令牌安全测试

##### 令牌完整性
- [ ] 令牌包含正确的签名
- [ ] 令牌类型验证正确
- [ ] 令牌过期时间合理（1小时）
- [ ] 令牌不能重复使用（可选）

##### 令牌攻击防护
- [ ] 无效签名令牌被拒绝
- [ ] 过期令牌被拒绝
- [ ] 错误类型令牌被拒绝
- [ ] 格式错误令牌被拒绝

#### 3. 速率限制测试

##### 忘记密码端点
- [ ] 单个 IP 限制正确工作
- [ ] 单个邮箱限制正确工作
- [ ] 速率限制消息正确显示
- [ ] 速率限制重置正常工作

##### 重置密码端点
- [ ] 重置尝试次数限制
- [ ] 恶意令牌尝试限制
- [ ] 速率限制不影响合法用户

### 性能测试

#### 1. 响应时间测试

##### API 响应时间
- [ ] 忘记密码请求 < 2秒
- [ ] 令牌验证 < 1秒
- [ ] 密码重置 < 3秒

##### 页面加载时间
- [ ] 页面初始加载 < 3秒
- [ ] 页面交互响应 < 500ms
- [ ] 表单验证响应 < 100ms

#### 2. 并发测试

##### 用户并发
- [ ] 100 个并发密码重置请求
- [ ] 系统保持稳定性
- [ ] 响应时间不显著降低

##### 单用户并发
- [ ] 同一用户多次重置请求
- [ ] 后续请求被正确限制
- [ ] 数据一致性保持

### 邮件系统测试

#### 1. 邮件发送测试

##### 邮件内容
- [ ] 重置链接格式正确
- [ ] 邮件模板正确渲染
- [ ] 用户名正确显示
- [ ] 链接有效期说明

##### 邮件投递
- [ ] 邮件成功发送
- [ ] 垃圾邮件过滤器测试
- [ ] 不同邮件提供商测试
- [ ] 邮件服务故障时的处理

#### 2. 邮件点击测试

##### 链接有效性
- [ ] 邮件中的链接可点击
- [ ] 链接跳转到正确页面
- [ ] 链接在不同邮件客户端中工作
- [ ] 移动端邮件客户端测试

### 错误处理测试

#### 1. 网络错误测试

##### 前端网络错误
- [ ] API 服务器不可用
- [ ] 网络超时
- [ ] DNS 解析失败
- [ ] 跨域请求失败

##### 后端网络错误
- [ ] 数据库连接失败
- [ ] 邮件服务连接失败
- [ ] 第三方服务不可用

#### 2. 数据错误测试

##### 数据库错误
- [ ] 连接池耗尽
- [ ] 查询超时
- [ ] 约束违反
- [ ] 数据不一致

##### 数据验证错误
- [ ] 类型错误处理
- [ ] 范围错误处理
- [ ] 格式错误处理
- [ ] 必填字段错误处理

### 业务逻辑测试

#### 1. 边界条件测试

##### 时间边界
- [ ] 令牌即将过期时的处理
- [ ] 令牌过期瞬间的处理
- [ ] 系统时间变更的影响

##### 数据边界
- [ ] 最长邮箱地址处理
- [ ] 最长密码处理
- [ ] 特殊字符处理

#### 2. 状态管理测试

##### 会话状态
- [ ] 用户状态正确维护
- [ ] 页面刷新后状态保持
- [ ] 浏览器后退/前进正确处理

##### 应用状态
- [ ] 错误状态正确清理
- [ ] 加载状态正确管理
- [ ] 成功状态正确传递

## 测试数据

### 测试账户
```
有效测试邮箱: test@example.com
无效邮箱: invalid-email-format
已存在用户: existing@example.com
不存在用户: nonexistent@example.com
```

### 测试密码
```
弱密码: "weak"
短密码: "short"
仅字母: "onlyletters"
仅数字: "12345678"
有效密码: "ValidPassword123!"
强密码: "StrongPassword123!@#"
```

### 测试令牌
```
有效令牌: (由系统生成)
无效令牌: "invalid-token"
过期令牌: (1小时前生成)
格式错误: "malformed.token.format"
```

## 验收标准

### 功能完整性
- [ ] 所有用户路径可以成功完成
- [ ] 所有错误情况有适当的处理
- [ ] 所有边界条件正确处理
- [ ] 所有安全要求得到满足

### 性能要求
- [ ] API 响应时间符合要求
- [ ] 页面加载时间符合要求
- [ ] 并发处理能力符合要求
- [ ] 内存使用合理

### 安全要求
- [ ] 所有输入得到验证和清理
- [ ] 所有安全威胁得到缓解
- [ ] 用户数据得到保护
- [ ] 审计日志完整

### 可用性要求
- [ ] 用户界面直观易用
- [ ] 错误消息清晰有帮助
- [ ] 响应式设计正确工作
- [ ] 可访问性标准得到满足

### 可靠性要求
- [ ] 系统在各种条件下稳定运行
- [ ] 错误恢复机制正确工作
- [ ] 数据一致性得到保证
- [ ] 服务可用性符合要求

## 测试报告模板

### 测试执行报告

```
测试日期: YYYY-MM-DD
测试人员: [姓名]
测试环境: [环境描述]
测试版本: [版本号]

执行结果:
- 通过: X 项
- 失败: Y 项
- 阻塞: Z 项
- 跳过: W 项

关键发现:
1. [发现描述]
2. [发现描述]

风险评估:
- 高风险: [数量] 项
- 中风险: [数量] 项
- 低风险: [数量] 项

建议:
1. [建议内容]
2. [建议内容]
```

### 缺陷报告模板

```
缺陷 ID: BUG-YYYY-XXXX
标题: [简短描述]
严重程度: [高/中/低]
优先级: [高/中/低]

环境信息:
- 浏览器: [浏览器版本]
- 操作系统: [OS 版本]
- 设备: [设备信息]

重现步骤:
1. [步骤1]
2. [步骤2]
3. [步骤3]

期望结果: [期望结果描述]
实际结果: [实际结果描述]

附件: [截图/日志/视频]
```

## 总结

这个综合测试方案提供了对 Cosnap AI 忘记密码功能的全面测试覆盖。通过执行所有测试用例，可以确保功能的可靠性、安全性和用户体验质量。

建议按以下顺序执行测试：
1. 单元测试（开发期间持续执行）
2. 集成测试（功能完成后执行）
3. 手动功能测试（测试环境验证）
4. E2E 测试（生产前验证）
5. 性能和安全测试（发布前执行）