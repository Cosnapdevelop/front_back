# 🚀 Render 部署 - 完整数据重置指南

## 概述

此指南专为在 Render 云平台部署的 Cosnap AI 应用提供安全的生产环境数据重置方案。

## ⚠️ 重要安全说明

**此操作将永久删除生产环境中的所有数据！**
- 所有用户账户和认证信息
- 所有帖子、评论和社区互动
- 所有支付和订阅记录
- 所有性能分析数据

**操作前请确认：**
- 这是测试环境或你确实需要重置生产数据
- 已备份任何重要数据（如有必要）
- 理解此操作不可撤销

## 🔐 安全特性

我们的重置系统包含多层安全保护：

1. **管理员密钥认证** - 64位随机生成密钥
2. **环境变量保护** - 必须显式启用生产重置
3. **确认码验证** - 双重确认机制
4. **API限流保护** - 每小时最多3次重置尝试
5. **详细日志记录** - 完整的操作审计追踪

## 📋 完整重置流程

### 第一步：部署更新的代码

确保最新的管理员API已部署到 Render：

1. **提交代码更改**：
   ```bash
   git add .
   git commit -m "feat: add production-safe database reset API"
   git push origin main
   ```

2. **Render 自动部署**：
   - Render 会自动检测到代码更改并开始部署
   - 等待部署完成（通常2-5分钟）

### 第二步：生成和配置管理员密钥

#### 2.1 生成管理员密钥

访问你的重置工具页面：
```
https://your-frontend-domain.vercel.app/reset-production.html
```

在工具中：
1. 输入你的 Render 后端API地址（例如：`https://your-backend-app.onrender.com`）
2. 点击 **"生成管理员密钥"** 按钮
3. 复制生成的64位密钥

#### 2.2 在 Render 中配置环境变量

1. **登录 Render Dashboard**
2. **选择你的后端服务**
3. **进入 Environment 选项卡**
4. **添加以下环境变量**：

   | 变量名 | 值 | 说明 |
   |--------|-----|------|
   | `ADMIN_RESET_KEY` | `[生成的64位密钥]` | 管理员认证密钥 |
   | `ALLOW_PRODUCTION_RESET` | `true` | 启用生产环境重置 |

5. **保存并重新部署服务**

### 第三步：执行数据库重置

回到重置工具页面：

1. **输入配置信息**：
   - API地址：你的 Render 后端地址
   - 管理员密钥：刚才配置的密钥

2. **检查当前数据**：
   - 点击 **"检查当前数据"** 查看数据库统计
   - 确认当前数据状态

3. **执行重置**：
   - 在确认码字段输入：`RESET_ALL_DATA_CONFIRMED`
   - 点击 **"重置数据库"** 按钮
   - 在确认对话框中再次确认

4. **等待完成**：
   - 操作通常需要10-30秒
   - 查看详细的删除统计信息

### 第四步：清除前端数据

数据库重置完成后：

1. **检测前端存储数据**：
   - 工具会显示浏览器中存储的所有相关数据

2. **清除本地数据**：
   - 点击 **"清除前端数据"** 按钮
   - 这会清除 localStorage、sessionStorage 和相关 cookies

### 第五步：验证重置结果

重置完成后进行验证：

1. **数据库验证**：
   - 重新点击 **"检查当前数据"**
   - 确认所有计数都为 0

2. **应用验证**：
   - 访问你的前端应用
   - 确认显示未登录状态
   - 尝试注册新用户确认功能正常

## 🔧 故障排除

### 常见问题及解决方案

#### 1. "Admin reset key not configured" 错误
**原因**：环境变量 `ADMIN_RESET_KEY` 未设置
**解决**：在 Render Dashboard 中添加该环境变量并重新部署

#### 2. "Production reset not enabled" 错误
**原因**：环境变量 `ALLOW_PRODUCTION_RESET` 未设置为 `true`
**解决**：添加该环境变量为 `true` 并重新部署

#### 3. "Too many reset attempts" 错误
**原因**：1小时内重置次数超过3次
**解决**：等待1小时后再试，或联系系统管理员

#### 4. "Database reset failed" 错误
**可能原因**：
- 数据库连接问题
- 外键约束冲突
- 权限不足

**解决步骤**：
1. 检查 Render 服务日志
2. 确认数据库连接正常
3. 必要时重启 Render 服务

#### 5. API 请求超时
**原因**：数据量大或网络延迟
**解决**：
- 等待更长时间（最多2分钟）
- 检查 Render 服务状态
- 查看服务日志获取详细信息

### 手动数据库重置（紧急情况）

如果Web界面无法使用，可以直接调用API：

```bash
curl -X POST "https://your-backend-app.onrender.com/api/admin/reset-database" \
  -H "Content-Type: application/json" \
  -H "X-Admin-Key: your-admin-key-here" \
  -d '{"confirmationCode": "RESET_ALL_DATA_CONFIRMED"}'
```

## 📊 操作审计

每次重置操作都会记录详细信息：

- **操作时间戳**
- **删除的记录数量**（按表统计）
- **操作者IP地址**
- **使用的管理员密钥**（哈希值）
- **操作结果状态**

这些日志可在 Render 服务日志中查看。

## 🔒 安全最佳实践

### 管理员密钥管理
- 使用强随机生成的密钥
- 定期轮换管理员密钥
- 不要在代码中硬编码密钥
- 重置完成后可删除环境变量（可选）

### 环境隔离
- 测试环境和生产环境使用不同密钥
- 生产环境重置功能仅在必要时启用
- 重置完成后可禁用 `ALLOW_PRODUCTION_RESET`

### 操作记录
- 保留重置操作的截图记录
- 记录重置的原因和负责人
- 建立重置操作的审批流程

## ✅ 重置完成检查清单

- [ ] Render 后端服务运行正常
- [ ] 管理员密钥已配置
- [ ] 数据库重置成功执行
- [ ] 前端本地数据已清除
- [ ] 数据库统计显示全部为0
- [ ] 前端应用显示未登录状态
- [ ] 新用户注册功能正常
- [ ] 重置日志已记录
- [ ] 环境变量已清理（可选）

## 🆘 技术支持

如果遇到无法解决的问题：

1. **收集错误信息**：
   - 浏览器控制台错误
   - Render 服务日志
   - 网络请求详情

2. **检查环境配置**：
   - 确认所有环境变量正确设置
   - 验证 Render 服务健康状态

3. **联系系统管理员**：
   - 提供详细的错误描述
   - 包含相关日志信息
   - 说明执行的具体步骤

---

**重要提醒**：生产环境数据重置是高风险操作，请严格按照此指南执行，并确保理解每个步骤的含义。